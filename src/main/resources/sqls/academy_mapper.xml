<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="academy">

	<select id="coupon_stock" resultType="CouponDto">
		SELECT client_no, client_name, menu_no, menu_title, menu_price, count(*) AS coupon_count
		FROM coupon 
		WHERE member_no = 100 AND coupon_state = 'Y'
		GROUP BY client_no, client_name, menu_no, menu_title, menu_price
		ORDER BY client_no
	</select>
	
	<select id="purchase_history" resultType="Coupon_historyDto">
		SELECT coupon_history_no, member_no, member_name, client_no, client_name, menu_no, menu_title, coupon_history_quantity, coupon_history_cost, coupon_history_date, coupon_history_info 
		FROM coupon_history 
		WHERE coupon_history_info = '구매' AND EXTRACT(year FROM coupon_history_date) = 2019 AND EXTRACT(month FROM coupon_history_date) = 2
	</select>
	
	<select id="sales_history" resultType="Coupon_historyDto">
		SELECT coupon_history_no, member_no, member_name, client_no, client_name, menu_no, menu_title, coupon_history_quantity, coupon_history_cost, coupon_history_date, coupon_history_info 
		FROM coupon_history 
		WHERE coupon_history_info = '판매' AND EXTRACT(year FROM coupon_history_date) = 2019 AND EXTRACT(month FROM coupon_history_date) = 1
	</select>
	
	<select id="menu_detail" parameterType="map" resultType="MenuDto">
		SELECT menu_no, client_no, client_name, menu_title, menu_price, menu_image, menu_detail, menu_create_date
		FROM menu
		WHERE client_no = #{client_no} AND menu_no = #{menu_no}
	</select>
	
	<select id="menu_list" parameterType="int" resultType="MenuDto">
		SELECT menu_no, client_no, client_name, menu_title, menu_price, menu_image, menu_detail, menu_create_date
		FROM menu
		WHERE client_no = #{client_no}
	</select>
	
	<select id="client_list" resultType="ClientDto">
		SELECT * FROM client WHERE client_registration = '승인'
	</select>
	
	<select id="client_registration_list" resultType="ClientDto">
		SELECT * FROM client WHERE client_registration = '대기'
	</select>
	
	<select id="client_update_registration" parameterType="int">
		UPDATE client SET client_registration = '승인' WHERE client_no = #{client_no}
	</select>
	
	
	<insert id="coupon_purchase_order" parameterType="map">
		INSERT ALL
		<foreach collection="coupon_info" item="couponDto">
		INTO coupon
		VALUES (coupon_seq.nextval,#{couponDto.member_no},#{couponDto.client_no},#{couponDto.menu_no},#{couponDto.client_name},#{couponDto.menu_title},#{couponDto.menu_price},#{couponDto.menu_image},#{couponDto.menu_detail},SYSDATE,'N',NULL,'N',NULL,NULL,'N')
		</foreach>
		SELECT * FROM DUAL
	</insert>
	
	<select id="coupon_purchase_order_list" resultType="CouponDto">
		SELECT client_no, client_name, menu_no, menu_title, menu_price, count(*) AS coupon_count, sum(menu_price) AS total_amount
		FROM coupon 
		WHERE member_no = 100 AND coupon_state = 'N'
		GROUP BY client_no, client_name, menu_no, menu_title, menu_price
		ORDER BY client_no
	</select>
	
	
	<select id="purchase_statistics" parameterType="map" resultType="int">
		SELECT SUM(coupon_history_quantity) 
		FROM coupon_history 
		WHERE coupon_history_info = '구매' AND EXTRACT(year FROM coupon_history_date) = #{year} AND client_no = #{client_no} 
		GROUP BY TO_CHAR(coupon_history_date,'MM') 
		ORDER BY TO_CHAR(coupon_history_date,'MM')
	</select>
	
	<select id="sale_statistics" parameterType="map" resultType="int">
		SELECT SUM(coupon_history_quantity) 
		FROM coupon_history 
		WHERE coupon_history_info = '판매' AND EXTRACT(year FROM coupon_history_date) = #{year} AND client_no = #{client_no} 
		GROUP BY TO_CHAR(coupon_history_date,'MM') 
		ORDER BY TO_CHAR(coupon_history_date,'MM')
	</select>
	

</mapper>
